# 后端技术规划
## 现状和问题
2016年团队进行了以引入laravel/lumen框架和实践微服务架构为核心后端技术建设，具体包括：

* 对laravel/lumen框架进行了充分的调研和性能评估；
* 遵循composer和psr-4规范迁移了大量基础库以兼容laravel/lumen框架；
* 解决laravel/lumen框架与orp和hhvm3.0的兼容性问题；
* 制定项目开发指南、RESTful API接口设计、数据库设计等规范；
* 制定微服务实践指南和实现API gateway服务；
* 研发基于lumen和orp的业务框架zdp；

百家号后端大体上以如上所述技术为基础进行建设，取得了不错的效果，但是也暴露一些问题，具体总结如：

### 框架与协作
* lumen框架基本特性和使用方法已经得到较好的普及，但是存在使用不规范和滥用的问题，另外高级特性使用率较低；
* 多人协作开发中，存在着不能互相理解代码，一言不合就copy基类的现象；
* 使用composer包共享代码受制于操作流程繁琐，没有被广泛使用；

### 数据库与优化
* 数据库设计规范较好的规范了数据库表结构的设计，可读性优先的设计理念被接受程度较好；
* 索引的使用由于没有做具体规范，所以使用的不好，造成一定量的慢查询；
* 一些影响查询速度特殊情况的知识没有被普及，造成一定量的慢查询，比如like、offset、join；

### 接口设计与错误处理
* 纯数据API能够较好的遵循RESTful API规范，但是一些视图URL本可以但是并没有遵循；
* 接口成功/失败时的格式在项目初期没有达成一致，随后解决；
* 项目初期代码中错误处理流程不统一，没有统一错误码、状态码，随后解决；

### 微服务架构的实践
* 由于项目大量依赖外部服务、工期、架构等问题微服务架构和API gateway没有被普遍使用；

## 规划
### 基础技术、编码/设计规范、协作效率
* 由于个人的自学能力差距，一些如lumen框架的基础技术需要引导大家进行学习和分享，避免拖后腿的情况发生；
* 接口设计规范和数据库设计规范需要对更深入和具体的细节做规范，并引入check和奖惩制度；
* 鼓励项目协作开发的成员相互review、refactor代码，保证一段代码至少有两个人能维护，避免个人阻塞项目整体的情况；

### 基础组件、业务框架抽象
* 组件/包封装依然是解决代码冗余、减小耦合、提高代码可复用性的银弹，lumen框架提供的console/command能力非常有利于自动化复杂组件/包的安装和使用，内外网隔离、passport/uuap鉴权、基于角色的权限管理等基础功能都需要封装为更为抽象的业务无关组件；
* 业务框架zdp提供的数据库设计、接口设计、逻辑开发流程较为粗糙，需要进一步深入细化，提供更多的特性与灵活性，避免滥用的情况发生；

### 日志、性能与优化
* 逆向的、以日志统计结果为导向的性能优化效率和效果都更好，需要完善现有的以access_log和ral_log为主的日志统计，对统计结果做更好的展现，并且加入报警机制；
* 普及PHP和mysql性能分析方法，规范索引和查询，记录和分享优化的经典case，避免重复踩坑的现象发生；
* 缓存机制需要更为合理、精细的加入接口与试图请求中，提高请求处理速度，减少系统负载；

### 微服务架构的实践
* 随着更多的模块被拆分出来，整个百家号系统更加复合微服务架构的特征，以lumen框架先进的ORM技术为基础，结合RPC技术预期可以大幅提高模块间的互操作性，减少繁琐的接口实现代码；